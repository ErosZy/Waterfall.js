(function(f,n,t,h){var s={container:"#waterfall-container",columns:[200,200,200,200],marginRight:20,marginBottom:20,isReusable:true,reuseCount:100,ajaxConf:{type:"GET",dataType:"json",url:"/"}};var p=t.documentElement.clientHeight||t.body.clientHeight,d=t.documentElement.clientWidth||t.body.clientWidth,l=0,r=0,A=[],a=[],v=false,o=[],z=0,i=1,B=[],q=40,c=[],w=false,m=0,k=0,u=null,g=null,e=null,x=null;var y=function(D,I){var G=function(L,K,J){return I(K,L,J)};if(Array.prototype.filter){return Array.prototype.filter.call(D,G)}else{var F=[];for(var E=0,C=D.length;E<C;E++){var H=D[E];if(G(E,H,D)){F.push(H)}}return F}};var b=function(D,G){var F=function(J,I,H){return G(I,J,H)};if(Array.prototype.some){return Array.prototype.some.call(D,F)}else{for(var E=0,C=D.length;E<C;E++){if(F(E,D[E],D)){return true}}}};function j(C){if(!(this instanceof j)){return new j(C)}this.opt=f.extend({},s,C);this.isStoped=false;q=this.opt.reuseCount;u=f(this.opt.container);g=u.offset();this._init()}j.prototype.stop=function(){this.isStoped=true};j.prototype.start=function(){this.isStoped=false};j.prototype.setColums=function(C){this._initColums(C);this._animate();this._reuse()};j.prototype.clear=function(){var C=this,D=f(C);u.html("").height(0);D.trigger("destory");A=a=o=B=c=[];f(n).off("scroll",e).off("resize",x);f.each(["loadBefore","loadComplete","loadError","render","destory"],function(E,F){D.off(F)})};j.prototype.on=function(){var C=f(this);C.on.apply(C,arguments);return this};j.prototype.off=function(){var C=f(this);C.off.apply(C,arguments);return this};j.prototype._init=function(){var C=this;C._initColums(C.opt.columns);C._addEvent();if(!C.isStoped){C._loadResources(function(D){C._render(D)})}setTimeout(function(){f(C).trigger("resize",d)})};j.prototype._initColums=function(G){var C=this,D=C.opt,F=D.marginRight,E=0;A=G.concat();A=f.map(A,function(){return 0});a=G.concat();f.each(a,function(H,I){a[H]=E;E+=(I+F)})};j.prototype._addEvent=function(){var C=this,D=f(C);e=function(E){if(C.isStoped){return}var F=f(n).scrollTop()-g.top;w=F-m<0;m=F;if((i+1)*p+F>=l){v=true;w=false;C._loadResources(function(G){C._render(G)})}else{C._reuse()}};x=function(E){clearTimeout(C.timer);C.timer=setTimeout(function(){d=t.documentElement.clientWidth||t.body.clientWidth;D.trigger("resize",d)},250)};f(n).on("scroll",e);f(n).on("resize",x)};j.prototype._loadResources=function(F){var C=this,D=f(C),E=C.opt.ajaxConf;E=f.extend({},E,{success:function(G){if(G){D.trigger("loadComplete",{data:G});z+=G.length;F.call(C,G);v=false}},error:function(G){D.trigger("loadError",G)}});D.trigger("loadBefore");f.ajax(E)};j.prototype._render=function(E){var C=this,D=C.opt.isReusable;if(E&&E.length){if(!D||q>=z){C._addItems(E)}else{C._loadReuse(E)}}};j.prototype._loadReuse=function(J){var D=this,E=f(D),I=f(n).scrollTop()-g.top,G=D._getReuseItems(o,F),H=G.length,C=J.length;if(H>C){G=G.splice(0,C)}else{if(H<C){J=J.splice(0,H)}}f.each(G,function(O,S){var L=J[O],R=L.width,N=L.height,P=D._calColumItemInfo(S,N),Q=P.top,M=P.left,K;K=E.triggerHandler("render",L);if(K){c.push({htmlStr:K,top:Q,left:M,width:R,height:N,index:k++});S.target.html(K);S.target.css({top:Q,left:M});D._setAttr(S,{top:Q,left:M,width:R,height:N});u.height(r)}});function F(K,L){return L.top+L.height<I+p}};j.prototype._reuse=function(){var C=this,J=f(n).scrollTop()-g.top,H=C._getReuseItems(c,G),E=o.concat(),I;for(var F=H.length-1;F>=0;F--){var D=b(o,function(K,L){return L.index==H[F].index&&L.top==H[F].top});if(D){H.splice(F,1)}}I=H.length;if(!I){return}E=E.sort(function(L,K){if(w){return(K.top+K.height)-(L.top+L.height)}else{return(L.top+L.height)-(K.top+K.height)}});E=E.splice(0,I);f.each(H,function(O,S){var R=S.width,N=S.height,M=S.index,P=E[O],Q,L,K;Q=S.top;L=S.left;K=S.htmlStr;P.target.html(K);P.target.css({top:Q,left:L});C._setAttr(P,{top:Q,left:L,width:R,height:N,index:M})});function G(K,L){var M=g.top;return L.top+L.height>J-p&&L.top<J+2*p}};j.prototype._getReuseItems=function(C,E){var D=[];D=y(C,E);D=D.sort(function(G,F){return G.top-F.top});return D};j.prototype._addItems=function(E){var C=this,D=f(C);f.each(E,function(J,O){var G=O.width,N=O.height,L=C._calColumItemInfo(O,N),M=L.top,H=L.left,J=k++,F,K;F=D.triggerHandler("render",O);if(F){var I=C.opt.columns;K=C._getItem(I[J%I.length],N,H,M);K.html(F);o.push({target:K,top:M,left:H,width:G,height:N,index:J});c.push({htmlStr:F,top:M,left:H,width:G,height:N,index:J});u.height(r);u.append(K)}})};j.prototype._getMin=function(){var C=Math.min.apply(Math,A),D=f.inArray(C,A);return{num:C,index:D}};j.prototype._getItem=function(D,C,F,E){return f("<div class='waterfall-item'></div>").css({position:"absolute",overflow:"hidden",height:C,width:D,top:E,left:F})};j.prototype._animate=function(){var D=this,H=f(n).scrollTop()-g.top,F,C,E;f.each(c,function(J,L){var K=L.height,I=D._calColumItemInfo(L,K);L.top=I.top;L.left=I.left});F=D._getReuseItems(c,G);C=F.length;E=o.length;F=C>=E?F.splice(0,E):F;f.each(F,function(M,Q){var O=Q.top,J=Q.left,K=Q.index,P=Q.width,L=Q.height,I=Q.htmlStr,N=o[M].target;
    N.html(I);N.css({top:O,left:J});o[M]={target:N,top:O,left:J,width:P,height:L,index:K}});function G(I,J){return J.top+J.height>H-p}};j.prototype._calColumItemInfo=function(G,D){var C=this,E=C._getMin(),F=C.opt,I,H;I=A[E.index];H=a[E.index];A[E.index]+=(D+F.marginBottom);l=Math.min.apply(Math,A);r=Math.min.apply(Math,A);return{top:I,left:H}};j.prototype._setAttr=function(E,C){for(var D in C){if(C.hasOwnProperty(D)){E[D]=C[D]}}};n.Waterfall=j}($,window,document));